<project name="metviewer" default="webapp" basedir=".">

    <description>METViewer build file</description>

    <!-- set global properties for this build -->
    <property name="src" location="java"/>
    <property name="lib" location="lib"/>
    <property name="build" location="build"/>
    <property name="dist" location="dist"/>

    <!-- Initialize the build tree -->
    <target name="init">

        <!-- Create the time stamp -->
        <tstamp/>

        <!-- Create the build directory structure used by compile -->
        <delete dir="${build}"/>
        <mkdir dir="${build}"/>

        <delete dir="${dist}"/>
        <mkdir dir="${dist}"/>

    </target>

    <!-- Compile the java code from ${src} into ${build} -->
    <target name="compile" depends="init" description="compile the source">

        <!-- Compile the project java files -->
        <javac srcdir="${src}" destdir="${build}">
            <classpath>
                <pathelement location="${lib}/log4j-1.2.15.jar"/>
                <pathelement location="${lib}/mysql-connector-java-5.1.6.jar"/>
                <pathelement location="${lib}/xercesImpl.jar"/>
                <pathelement location="${lib}/xml-apis.jar"/>
                <pathelement location="${lib}/servlet-api.jar"/>
                <pathelement location="${lib}/commons-fileupload-1.3.jar"/>
                <pathelement location="${lib}/commons-io-2.4.jar"/>
                <pathelement location="${lib}/bonecp-0.7.1.RELEASE.jar"/>
                <!--pathelement location="${lib}/junit-4.11.jar"/>
                <pathelement location="${lib}/hamcrest-core-1.3.jar"/-->
            </classpath>
            <exclude name="**/test/**"/>
        </javac>

    </target>
    <target name="compile-all" depends="init" description="compile the source">
        <!-- Compile the project java files -->
        <javac srcdir="${src}" destdir="${build}">
            <classpath>
                <pathelement location="${lib}/log4j-1.2.15.jar"/>
                <pathelement location="${lib}/mysql-connector-java-5.1.6.jar"/>
                <pathelement location="${lib}/xercesImpl.jar"/>
                <pathelement location="${lib}/xml-apis.jar"/>
                <pathelement location="${lib}/servlet-api.jar"/>
                <pathelement location="${lib}/commons-fileupload-1.3.jar"/>
                <pathelement location="${lib}/commons-io-2.4.jar"/>
                <pathelement location="${lib}/bonecp-0.7.1.RELEASE.jar"/>
                <pathelement location="${lib}/junit-4.11.jar"/>
                <pathelement location="${lib}/hamcrest-core-1.3.jar"/>
                <pathelement location="${lib}/mockito-all-1.9.5.jar"/>
            </classpath>
        </javac>

    </target>

    <!-- Create the distribution directory -->
    <target name="dist" depends="compile"
            description="generate the distribution">

        <!-- Create the dist lib folder and put the jared class files there -->
        <mkdir dir="${dist}/lib"/>
        <jar jarfile="${dist}/lib/metviewer.jar" basedir="${build}"/>

    </target>

    <target name="dist-test" depends="compile-all"
            description="generate the distribution">

        <!-- Create the dist lib folder and put the jared class files there -->
        <mkdir dir="${dist}/lib"/>
        <jar jarfile="${dist}/lib/metviewer_all.jar" basedir="${build}"/>

    </target>

    <!-- Build the web application folder -->
    <target name="webapp" depends="dist, dist-test"
            description="build the web application bundle">

        <!-- Copy the webapp contents to the dist folder -->
        <delete dir="${dist}/metviewer"/>
        <copy todir="${dist}/metviewer">
            <fileset dir="webapp/metviewer"/>
        </copy>

        <!-- Copy the R_work/include folder R files -->
        <mkdir dir="${dist}/metviewer/R_work/include"/>
        <copy todir="${dist}/metviewer/R_work/include">
            <fileset dir="R_work/include">
                <include name="*.R"/>
            </fileset>
        </copy>

        <!-- Copy the support jar files to the dist folder -->
        <copy todir="${dist}/metviewer/WEB-INF/lib">
            <fileset dir="${lib}">
                <include name="*.jar"/>
                <exclude name="junit-4.11.jar"/>
                <exclude name="hamcrest-core-1.3.jar"/>
                <exclude name="mockito-all-1.9.5.jar"/>
            </fileset>
        </copy>
        <copy todir="${dist}/metviewer/WEB-INF/lib"
              file="${dist}/lib/metviewer.jar"/>

        <!-- Copy the documentation files -->
        <mkdir dir="${dist}/metviewer/doc"/>
        <copy todir="${dist}/metviewer/doc">
            <fileset dir="doc">
                <include name="*"/>
            </fileset>
        </copy>

    </target>

    <!-- Delete the ${build} and ${dist} directory trees -->
    <target name="clean" description="clean up">
        <delete dir="${build}"/>
        <delete dir="${dist}"/>
    </target>

</project>

