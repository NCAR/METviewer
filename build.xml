<project name="metviewer" default="all" basedir=".">

    <description>METViewer build file</description>

    <!-- set global properties for this build -->
    <property name="src" location="java"/>
    <property name="lib" location="lib"/>
    <property name="build" location="build"/>
    <property name="dist" location="dist"/>

    <!-- Initialize the build tree -->
    <target name="init">

        <!-- Create the time stamp -->
        <tstamp/>

        <!-- Create the build directory structure used by compile -->
        <delete dir="${build}"/>
        <mkdir dir="${build}"/>

        <delete dir="${dist}"/>
        <mkdir dir="${dist}"/>

    </target>

    <!-- Compile the java code from ${src} into ${build} -->
    <target name="compile" depends="init" description="compile the source">

        <!-- Compile the project java files -->
        <javac srcdir="${src}" destdir="${build}">
            <classpath>
                <pathelement location="${lib}/log4j-1.2.15.jar"/>
                <pathelement location="${lib}/log4j-api-2.8.2.jar"/>
                <pathelement location="${lib}/log4j-core-2.8.2.jar"/>
                <pathelement location="${lib}/log4j-iostreams-2.8.2.jar"/>
                <pathelement location="${lib}/mysql-connector-java-5.1.6.jar"/>
                <pathelement location="${lib}/xercesImpl.jar"/>
                <pathelement location="${lib}/xml-apis.jar"/>
                <pathelement location="${lib}/servlet-api.jar"/>
                <pathelement location="${lib}/commons-fileupload-1.3.jar"/>
                <pathelement location="${lib}/commons-io-2.4.jar"/>
                <pathelement location="${lib}/bonecp-0.7.1.RELEASE.jar"/>
                <pathelement location="${lib}/j2html-0.7.jar"/>
                <pathelement location="${lib}/jackson-core-2.8.5.jar"/>
                <pathelement location="${lib}/jackson-databind-2.8.5.jar"/>
                <pathelement location="${lib}/commons-lang3-3.5.jar"/>

            </classpath>
            <exclude name="**/test/**"/>
        </javac>

    </target>
    <target name="compile-all" depends="init" description="compile the source">
        <!-- Compile the project java files -->
        <javac srcdir="${src}" destdir="${build}">
            <classpath>
                <pathelement location="${lib}/log4j-1.2.15.jar"/>
                <pathelement location="${lib}/log4j-api-2.8.2.jar"/>
                <pathelement location="${lib}/log4j-core-2.8.2.jar"/>
                <pathelement location="${lib}/log4j-iostreams-2.8.2.jar"/>
                <pathelement location="${lib}/mysql-connector-java-5.1.6.jar"/>
                <pathelement location="${lib}/xercesImpl.jar"/>
                <pathelement location="${lib}/xml-apis.jar"/>
                <pathelement location="${lib}/servlet-api.jar"/>
                <pathelement location="${lib}/commons-fileupload-1.3.jar"/>
                <pathelement location="${lib}/commons-io-2.4.jar"/>
                <pathelement location="${lib}/bonecp-0.7.1.RELEASE.jar"/>
                <pathelement location="${lib}/junit-4.11.jar"/>
                <pathelement location="${lib}/hamcrest-core-1.3.jar"/>
                <pathelement location="${lib}/mockito-all-1.9.5.jar"/>
                <pathelement location="${lib}/j2html-0.7.jar"/>
                <pathelement location="${lib}/jackson-core-2.8.5.jar"/>
                <pathelement location="${lib}/jackson-databind-2.8.5.jar"/>
                <pathelement location="${lib}/commons-lang3-3.5.jar"/>

            </classpath>
        </javac>

    </target>

    <!-- Create the distribution directory -->
    <target name="dist" depends="compile"
            description="generate the distribution">

        <!-- Create the dist lib folder and put the jared class files there -->
        <mkdir dir="${dist}/lib"/>
        <mkdir dir="${build}/edu/ucar/metviewer/resources"/>
        <copy todir="${build}/edu/ucar/metviewer/resources">
            <fileset dir="${src}/edu/ucar/metviewer/resources">
                <include name="**/*.xml"/>
            </fileset>
        </copy>
        <jar jarfile="${dist}/lib/metviewer.jar" basedir="${build}">

        </jar>
    </target>

    <target name="dist-test" depends="compile-all"
            description="generate the distribution">

        <!-- Create the dist lib folder and put the jared class files there -->
        <mkdir dir="${dist}/lib"/>
        <jar jarfile="${dist}/lib/metviewer_all.jar" basedir="${build}"/>

    </target>

    <!-- Build the web application folder -->
    <target name="webapp" depends="dist, dist-test"
            description="build the web application bundle">
        <!-- Copy the webapp contents to the dist folder -->
        <delete dir="${dist}/metviewer"/>
        <copy todir="${dist}/metviewer">
            <fileset dir="webapp/metviewer">
                <exclude name="**/*.ncep"/>
                <exclude name="**/*.noaa"/>
                <exclude name="**/*.dev"/>
                <exclude name="**/*mvservlet_psql.properties"/>
            </fileset>
        </copy>

        <!-- Copy the R_work/include folder R files -->
        <mkdir dir="${dist}/metviewer/R_work/include"/>
        <copy todir="${dist}/metviewer/R_work/include">
            <fileset dir="R_work/include">
                <include name="*.R"/>
            </fileset>
        </copy>

        <!-- Copy the R_tmpl folder R files -->
        <mkdir dir="${dist}/metviewer/R_tmpl"/>
        <copy todir="${dist}/metviewer/R_tmpl">
            <fileset dir="R_tmpl">
                <include name="*tmpl"/>
            </fileset>
        </copy>


        <!-- Copy the support jar files to the dist folder -->
        <copy todir="${dist}/metviewer/WEB-INF/lib">
            <fileset dir="${lib}">
                <include name="*.jar"/>
                <exclude name="servlet-api.jar"/>
                <exclude name="junit-4.11.jar"/>
                <exclude name="hamcrest-core-1.3.jar"/>
                <exclude name="mockito-all-1.9.5.jar"/>
            </fileset>
        </copy>
        <copy todir="${dist}/metviewer/WEB-INF/lib"
              file="${dist}/lib/metviewer.jar"/>

        <!-- Copy the documentation files -->
        <mkdir dir="${dist}/metviewer/doc"/>
        <copy todir="${dist}/metviewer/doc">
            <fileset dir="doc">
                <include name="*"/>
            </fileset>
        </copy>

    </target>

    <!-- Delete the ${build} and ${dist} directory trees -->
    <target name="clean" description="clean up">
        <delete dir="${build}"/>
        <delete dir="${dist}"/>
    </target>

    <target name="war" depends="webapp" description="Create web archive">
        <delete file="${dist}/metviewer.war"/>
        <war destfile="${dist}/metviewer.war"
             webxml="${dist}/metviewer/WEB-INF/web.xml"
             basedir="${dist}/metviewer">
        </war>
    </target>

    <target name="batch_load" depends="dist" description="Create load_batch module">
        <tar destfile="${dist}/batch_load.tar">
            <tarfileset dir=".">
                <exclude name="**/*.war"/>
                <exclude name="**/*.tar"/>
                <include name="bin/**"/>
                <include name="dist/lib/metviewer.jar"/>
                <include name="R_work/**"/>
                <include name="R_tmpl/**"/>
                <include name="sql/**"/>
                <include name="lib/**"/>
            </tarfileset>
        </tar>
    </target>
    <target name="all" depends="war,batch_load" description="Create all modules"/>

</project>

